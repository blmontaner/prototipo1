<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <title>Facelet Title</title>
                    <script src="resources/wavesurfer.js" type="text/javascript" />
            <script src="resources/webaudio.js" type="text/javascript" />
            <script src="resources/drawer.js" type="text/javascript" />
            <script src="resources/drawer.canvas.js" type="text/javascript" />

            <script src="resources/drawer.svg.js" type="text/javascript" />
            
             <script type="text/javascript">
                /* <![CDATA[ */
                var wavesurferMap = {};
                function wavesurferFactoryGetOne(idVideo){
                    var wavesurf = Object.create(WaveSurfer);
                    wavesurferMap[idVideo] = wavesurf;
                    return wavesurf;
                }
                
                function playAll(){
                    for(var i = 0; i < wavesurferMap.length; i++){
                        wavesurferMap[i].playPause();
                    }
                }
                /* ]]> */
              </script>    
                 

    </h:head>
    <h:body>
        Hello from Facelets
        <ui:repeat value="#{mix.currentVideos}" var="video" id="video" > 
            <div >
                <div id="wave#{video.getId()}" style="width:450px">
                    <div id="waveform#{video.getId()}">

                    </div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" data-action="back#{video.getId()}">
                    <i class="glyphicon glyphicon-step-backward"></i>
                    Backward
                </button>

                <button class="btn btn-primary" data-action="play#{video.getId()}">
                    <i class="glyphicon glyphicon-play"></i>
                    Play
                    /
                    <i class="glyphicon glyphicon-pause"></i>
                    Pause
                </button>

                <button class="btn btn-primary" data-action="forth#{video.getId()}">
                    <i class="glyphicon glyphicon-step-forward"></i>
                    Forward
                </button>

                <button class="btn btn-primary" data-action="toggle-mute#{video.getId()}">
                    <i class="glyphicon glyphicon-volume-off"></i>
                    Toggle Mute
                </button>

            </div>
            <div class="progress-bar" id="progress-bar#{video.getId()}">

            </div>
            <script type="text/javascript">
                /* <![CDATA[ */

                // Create an instance
                var wavesurfer = wavesurferFactoryGetOne(#{video.getId()});

                // Init n load mp3
                document.addEventListener('DOMContentLoaded', function() {
                    var options = {
                        container: document.querySelector('#waveform#{video.getId()}'),
                        waveColor: 'blue',
                        progressColor: 'grey',
                        loaderColor: 'purple',
                        cursorColor: 'navy',
                        markerWidth: 2
                    };

                    if (location.search.match('scroll')) {
                        options.minPxPerSec = 100;
                        options.scrollParent = true;
                    }

                    if (location.search.match('normalize')) {
                        options.normalize = true;
                    }

                    if (location.search.match('svg')) {
                        options.renderer = 'SVG';
                    }

                    /* Progress bar */
                    var progressDiv = document.querySelector('#progress-bar#{video.getId()}');
                    var progressBar = progressDiv.querySelector('.progress-bar#{video.getId()}');
                    wavesurfer.on('loading', function(percent, xhr) {
                        progressDiv.style.display = 'block';
                        progressBar.style.width = percent + '%';
                    });
                    wavesurfer.on('ready', function() {
                        progressDiv.style.display = 'none';
                    });

                    // Init
                    wavesurfer.init(options);
                    // Load audio from URL
                    wavesurfer.load("#{video.getPathAudio()}");

                    // Start listening to drag'n'drop on document
                    wavesurfer.bindDragNDrop('#drop');
                });

                // Play at once when ready
                // Won't work on iOS until you touch the page
                wavesurfer.on('ready', function() {
                    //wavesurfer.play();
                });

                // Bind buttons and keypresses
                (function() {
                    var eventHandlers = {
                        'play#{video.getId()}': function() {
                            wavesurfer.playPause();
                        },
                        'back#{video.getId()}': function() {
                            wavesurfer.skipBackward();
                        },
                        'forth#{video.getId()}': function() {
                            wavesurfer.skipForward();
                        },
                        'toggle-mute#{video.getId()}': function() {
                            wavesurfer.toggleMute();
                        }
                    };

                    document.addEventListener('keydown', function(e) {
                        var map = {
                            32: 'play#{video.getId()}', // space
                            37: 'back#{video.getId()}', // left
                            39: 'forth#{video.getId()}'       // right
                        };
                        if (e.keyCode in map) {
                            var handler = eventHandlers[map[e.keyCode]];
                            e.preventDefault();
                            handler && handler(e);
                        }
                    });

                    document.addEventListener('click', function(e) {
                        var action = e.target.dataset && e.target.dataset.action;
                        if (action && action in eventHandlers) {
                            eventHandlers[action](e);
                        }
                    });
                }());

                // Flash mark when it's played over
                wavesurfer.on('mark#{video.getId()}', function(marker) {
                    if (marker.timer) {
                        return;
                    }

                    marker.timer = setTimeout(function() {
                        var origColor = marker.color;
                        marker.update({color: 'yellow'});

                        setTimeout(function() {
                            marker.update({color: origColor});
                            delete marker.timer;
                        }, 100);
                    }, 100);
                });

                wavesurfer.on('error', function(err) {
                    console.error(err);
                });




                /* ]]> */
            </script>
        </ui:repeat>
        <div>
            <button onclick=" " > Play </button>
            <!--<script src="resources/soundmanager2.js" type="text/javascript" />-->

        </div>
    </h:body>
</html>

